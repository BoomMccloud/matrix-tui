# Memory & Persistence

## Overview

Two layers of persistence keep state across bot restarts and Gemini invocations.

---

## Layer 1 — Orchestrator Memory (survives reboots)

**What:** Room-to-container mappings and full conversation histories stored in a single JSON file on the host.

**Where:** `/home/matrix-tui/state.json`

```json
{
  "containers": {
    "!roomid:server": "sandbox-roomid-server"
  },
  "history": {
    "!roomid:server": [
      {"role": "system", "content": "..."},
      {"role": "user", "content": "..."},
      {"role": "assistant", "content": "..."}
    ]
  }
}
```

**Container naming:** containers are named from a slug of the room ID (`sandbox-<slug>`), not random IDs. On startup, the bot calls `podman inspect` on each saved name to confirm it's still running and reconnects if so. Stale entries are dropped.

**Write triggers:**
- After `sandbox.create()` — new container mapping
- After `sandbox.destroy()` — entry removed
- After each agent reply — history saved

**Atomic writes:** written to `.tmp` then renamed to avoid corruption on crash.

---

## Layer 2 — Gemini Agent Memory (workspace context files)

**What:** Gemini reads prior task history and workspace conventions before each invocation, and appends what it did afterward.

**Where:** Files inside the sandbox container at `/workspace/`:

```
/workspace/
├── GEMINI.md       # Auto-loaded by Gemini CLI on every invocation
│                   # Imports status.md so Gemini sees prior work
├── status.md       # Append-only task log
└── <repo>/
    └── GEMINI.md   # Repo-specific context (generated by /init)
    └── AGENTS.md   # Conventions and gotchas discovered during work
```

**GEMINI.md rules given to Gemini:**
1. Read `status.md` (imported) before starting any task
2. Read `AGENTS.md` in repo root for conventions
3. Append one line to `status.md` after each task
4. Append discoveries to `AGENTS.md`
5. After cloning a new repo, run `/init` to generate repo-specific `GEMINI.md`

**AfterAgent hook** writes the timestamp entry to `status.md` automatically after every Gemini session — Gemini doesn't need to remember to do it.

---

## What is NOT persisted

- History is unbounded — no trimming (acceptable for current usage)
- `state.json` contains no secrets, only message text and container names
- Each room is fully isolated — no cross-room context sharing
